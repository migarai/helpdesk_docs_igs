# Legacy to Prod

## Pre - Migration
In most cases the migration is happens for sites that are already in use. It is cruicial to backup and keep the data records as a environment change is happening.

  ### 1. Backing up QR codes.
  If Site has QR codes we need to save them in order.

  1. Connect to the **Legacy** database.
  2. Select `dtvd_hammertech` database.
  3. Select `assignments` collection.
  4. Run the following Aggregation. <span style={{color: 'red'}}>Replace the **project** value with **legacy project Id**.</span>
  ```bash title="ht_list.csv"
  [
    {
      $match: {
        project: "67859e3b52530bb0118cf0d9",
      },
    },
    {
      $lookup: {
        from: "workers",
        localField: "worker",
        foreignField: "ig_id",
        as: "worker",
      },
    },
    {
      $unwind: {
        path: "$worker",
        preserveNullAndEmptyArrays: true,
      },
    },
    {
      $match: {
        "worker.ig_id": {
          $exists: true,
          $ne: null,
          $ne: "",
        },
      },
    },
    {
      $project: {
        _id: 0,
        first: "$worker.first",
        last: "$worker.last",
        hammertech_id: "$worker.hammertech_id",
        ig_id: "$worker.ig_id",
      },
    },
  ]
  ```
    5. Export the results as `ht_list.csv`
    In MongoDB compass, `Export` >> `.csv`

### 2. Export QR Access Key List.

  1. Switch to `dtvd_employee` database.
  2. Select `assignments` collections.
  3. Run the following Aggregation.
    <span style={{color: 'red'}}>Replace the **site** value with **legacy project Id**.</span>
    ```txt title="qr_list.csv"
    [
      {
        $match: {
          site: ObjectId("67859e3b52530bb0118cf0d9"),
        },
      },
      {
        $lookup: {
          from: "accesskeys",
          localField: "user",
          foreignField: "user",
          as: "accessKey",
        },
      },
      {
        $unwind: {
          path: "$accessKey",
          includeArrayIndex: "0",
          preserveNullAndEmptyArrays: false,
        },
      },
      {
        $lookup: {
          from: "users",
          localField: "user",
          foreignField: "_id",
          as: "user",
        },
      },
      {
        $unwind: {
          path: "$user",
          includeArrayIndex: "0",
          preserveNullAndEmptyArrays: false,
        },
      },
      {
        $match: {
          "accessKey.qr": {
            $exists: true,
          },
          "accessKey.kind": "ACCESS",
          "accessKey.status": "ACTIVE",
        },
      },
      {
        $project: {
          _id: 1,
          name: "$user.fullName",
          qrCode: "$accessKey.legibleKey",
          user: "$user._id",
        },
      },
    ]
    ```
  4. Export the results as qr_list.csv.

### 3. Migrate QR codes.

  1. Download the script. [Link](https://prettier.io/).
  2. Move the exported data (*ht_list.csv* and *qr_list.csv*) into `./data/qr_migrator/` of the extracted project.
  3. Change the `.env`.
  4. Install required dependencies.
    ```bash
    yarn
    ```
  5. Start the script.
    ```bash
    yarn start
    ```
  :::danger
  Make sure script worked correctly !!!
  :::
  :::important
  Usually, there will be a checklist that need to be filled.
  :::

## Migration
1. Connect to RPI.
2.  Install [nvm](/docs/General/node#nvm) version 19
    ```bash
    $ nvm install 19
    $ nvm alias default 19.x.x
    $ nvm uninstall 14
    ```
    Single command,
    ```
    nvm install 19 && nvm alias default 19 && nvm uninstall 14
    ```
4. Install [yarn](/docs/General/node#yarn) and [pm2](/docs/General/pm2).
   ```bash
   npm install -g yarn pm2
   ```
5. Move legacy files (docker setup)
   ```bash
   mv client old.client
   ```
6. Create folder for v2 setup
   ```bash
   mkdir v2Client
   ```
7. Edit **cron table**
   ```bash
   crontab -e
   ```
   Comment out the last line (sedn cron) and change the "client" to "old.client" in  first line.
   ![Crontab](/images/crontab.edit.png)
8. install pm2 as a service.
   ```bash
   pm2 start up
   ```
   :::note
   If above command didn't work, use the below command.
   ```bash
   pm2 startup
   ```
   :::
   Proceed with displayed steps.
9. Start [Ngrok](/docs/essentials#ngrok-remote-connection).
   ```bash
   ngrok tcp 22
   ```
   Get the **address** and **port**.
10. Remote connect from [**WinSCP**}(/docs/essentials#using-ngrok-and-winscp).
11. Get the [**prod code**](https://360holdings-my.sharepoint.com/:u:/g/personal/migaram_i360_lk/EZ8sHwHyHrNAoPg0Vg8kxBIBqdPKxC0J7FQR_ZFUz5w_nw?e=mCTZyb) and extract its content. Paste the files in `/v2Client`
    ![WinSCP v2Client](/images/winscp.v2client.png)
12. [Get the IoT Credentials](/docs/essentials#get-iot-credentials) and paste in `v2Client/creds/`.
13. Terminate **Ngrok** session and exit **WinSCP**.
14. `cd` to `/v2Client`.
15. Edit `.env` file. (Can do this with WinSCP as well.)
    * `CLIENT_ID` - IoT Thing name (*A396_3lxwHVymlR*)
    * `TIMEZONE`. Add the Correct time zone. (*Europe/London*)
    * `TZX` - timezone (*Europe/London*)
    * `CLIENT` - Add the client name.
    * `Project` - Add the site name.
    :::important
    If the setup is using **Dahua** devices,
    * `TZ_OFFSET` = 1
    * Change the RPI timezone to readers timezone.
      `sudo raspi-config`
    :::
16. Install dependencies and build project.
    ```bash
    $ yarn
    $ yarn build
    ```
    Build will take few minutes.
17. Install Python dependencies.
    ```bash
    python3 -m pip install Flask python-dotenv
    ```
18. Delete `src` folder.
    ```bash
    rm -r src
    ```
19. Start pm2 service.
    ```bash
    pm2 start ecosystem.config.js
    ```
20. Save this pm2 instance so it will start automatically after a reboot.
    ```bash
    pm2 save
    ```
    :::tip
    Check again after RPI reboot to ensure the pm2 running automatically.
    ```bash
    pm2 logs
    ```
    :::
