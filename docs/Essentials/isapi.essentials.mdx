# ISAPI - API Requests for Devices

Intelligent Security API (ISAPI) is an API proctocol used by Hikvision devices (IP cameras, Access controls) over HTTP or HTTPS to control devices remotly. ([see more](https://partner.hikvision.com/download/))   

**There are several methods to send API requests to devices**   
* Send **cURL** requests through RPI.  
* Port-forwarding RPI through **PuTTy**  
* Port-forwarding RPI through **Ngrok**  

## Direct cURL from RPI
1. Tunnel to RPI. (through [Ngrok](/docs/essentials#ngrok-remote-connection), openVPN or RMS)  
2. Send the API requests through **cURL**  
   eg: Set timezone
        ```text
        http://172.16.1.175:80/ISAPI/System/time
        ```
        ```bash
        curl --request PUT \
        --url http://172.16.1.175:80/ISAPI/System/time \
        --header 'Content-Type: application/xml' \
        --data 
        ```

:::tip
You can download the **Insomnia** import file. ([download](https://360holdings-my.sharepoint.com/:f:/g/personal/migaram_i360_lk/Ehm0h5FBzYJDmHaDWY9XjzgB6cBYovP1Vyn6YTVyoF5CfQ?e=T679Cz))  
Get the **cURL** from [here](/)
:::  

##  Port-Forwarding RPI through Ngrok

1. Tunnel to RPI.
2. [Install Ngrok](/docs/essentials#ngrok-installation)  
3. Add your auth token. (get auth token from [here](https://dashboard.ngrok.com/get-started/your-authtoken))  
4. Get the devices IP addresses that in network.  
    ```bash
    scan
    ```  
5. Forward the related port using **ngrok**  
    ```bash
    ngrok http 192.168.1.165:80
    ```
6. This will show ngrok address and port. modify the address and port in the API request and send.  
   ![FR Port Forwarding](/images/frport.ngrok.png)  

7. Get the address and change the API address accordingly.  
   eg: `https://1de8-80-233-45-164.ngrok-free.app` 

8. Send the request. (Sometimes pre-made rquests not working. try to create new one or use curl)  ([see cURLs](#curl-list))  
    CURL for "Get Time" request
    ```bash
    curl --request GET \
    > "https://5246-80-233-40-243.ngrok-free.app/ISAPI/System/time" \
    > -u "admin:Hik12345" \
    > -H "Content-Type:application/json" \
    > --digest
    ```


## CURL List

### FR (DS-K1T341CMF)  
:::note
Replace the addresses and other nessessary parameters. These are based on local network. 
:::
* Get Time
  ```bash
  curl --request GET \
  "http://192.168.1.165:80/ISAPI/System/time" \
  -H "Content-Type:application/json" \
  -u "admin:Hik12345" \
  --digest
  ```  
* Get Time Zone  
  ```bash
  curl --request GET \
  "http://192.168.1.165:80/ISAPI/System/time/timeZone" \
  -H "Content-Type:application/json" \
  -u "admin:Hik12345" \
  --digest
  ```
* Get NTP Servers  
  ```bash
  curl --request GET \
  "http://192.168.1.165:80/ISAPI/System/time/ntpServers" \
  -H "Content-Type:application/json" \
  -u "admin:Hik12345" \
  --digest
  ```

* Get Door Parameters  
  ```bash
  curl --request GET \
  "http://192.168.1.165:80/ISAPI/AccessControl/Door/param/1" \
  -H "Content-Type:application/json" \
  -u "admin:Hik12345" \
  --digest
  ``` 
* Set Time Zone  
  ```bash
  curl --request PUT \
  --url "http://192.168.1.165:80/ISAPI/System/time/timeZone" \
  -H "Content-Type:text/plain" \
  -u "admin:Hik12345" \
  --digest \
  --data 'CST+0:00:00DST01:00:00,M3.5.0/02:00:00,M10.5.0/02:00:00'
  ```

* Update NTP server 
  ```bash
  curl --request PUT \
  --url "http://192.168.1.165:80/ISAPI/System/time/ntpServers/1" \
  -H "COntent-Type:text/xml" \
  -u "admin:Hik12345" \
  --digest \
  --data '
  <Time version="2.0" xmlns="http://www.isapi.org/ver20/XMLSchema">
    <timeMode>NTP</timeMode>
    <NTPServer>
        <id>1</id>
        <addressingFormatType>hostname</addressingFormatType>
        <hostName>time.google.com</hostName>
        <portNo>150</portNo>
        <synchronizeInterval>40</synchronizeInterval>
    </NTPServer>
  </Time>'
  ```

### Frequently Used Ones
  1. Delete Users from FR.  
      **For Entry FR (...165)**
      ```bash
      curl --request PUT \
      --url 'http://192.168.1.165:80/ISAPI/AccessControl/UserInfoDetail/Delete?format=json' \
      --header 'Accepts: application/json' \
      --header 'Content-Type: application/json' \
      --header 'Content-Type	: application/json' \
      -u "admin:Hik12345" \
      --digest \
      --data '{
      "UserInfoDetail":{
      "mode":"all",
      "EmployeeNoList":[]
      }
      }'
      ```
      **For Exit FR (...166)**
      ```bash
      curl --request PUT \
      --url 'http://192.168.1.166:80/ISAPI/AccessControl/UserInfoDetail/Delete?format=json' \
      --header 'Accepts: application/json' \
      --header 'Content-Type: application/json' \
      --header 'Content-Type	: application/json' \
      -u "admin:Hik12345" \
      --digest \
      --data '{
      "UserInfoDetail":{
      "mode":"all",
      "EmployeeNoList":[]
      }
      }'
      ```